{"ast":null,"code":"import _defineProperty from \"/home/paria/sandbox/projects/webfon-V2/webfonv2/node_modules/@babel/runtime/helpers/esm/defineProperty\";\nimport _slicedToArray from \"/home/paria/sandbox/projects/webfon-V2/webfonv2/node_modules/@babel/runtime/helpers/esm/slicedToArray\";\nvar _jsxFileName = \"/home/paria/sandbox/projects/webfon-V2/webfonv2/src/components/chat-box/index.js\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nimport React, { useEffect, useState } from \"react\";\nimport MessagePopUp from \"../message-popup\";\nimport \"./style.css\";\nimport $ from \"jquery\";\nimport { useSelector } from \"react-redux\";\nimport Search from \"../search/search\";\n\nconst ChatBox = () => {\n  const selectedContact = useSelector(state => state.selectedContact);\n  const $iq = useSelector(state => state.$iq);\n  const $msg = useSelector(state => state.$msg);\n  const connection = useSelector(state => state.connection);\n  const showMainPage = useSelector(state => state.showMainPage);\n\n  const _useState = useState([]),\n        _useState2 = _slicedToArray(_useState, 2),\n        historyMessages = _useState2[0],\n        setHistoryMessages = _useState2[1];\n\n  const _useState3 = useState([]),\n        _useState4 = _slicedToArray(_useState3, 2),\n        allMessages = _useState4[0],\n        setAllMessages = _useState4[1];\n\n  const _useState5 = useState(\"\"),\n        _useState6 = _slicedToArray(_useState5, 2),\n        messageText = _useState6[0],\n        changeMessageText = _useState6[1];\n\n  const sendLastActivity = useSelector(state => state.sendLastActivity);\n  useEffect(() => {\n    getLog();\n  }, [selectedContact]);\n\n  const getLog = () => {\n    let sentMessages,\n        recMessages,\n        history = [],\n        archiveIq = $iq({\n      type: \"set\",\n      id: \"archive1\"\n    }).c(\"query\", {\n      xmlns: \"urn:xmpp:mam:2\"\n    }).c(\"set\", {\n      xmlns: \"http://jabber.org/protocol/rsm\"\n    }).c('max').t('5');\n    connection.mam.query(connection.send(archiveIq), {\n      with: selectedContact,\n      onMessage: function (message) {\n        $(message).each(function () {\n          if ($(this).find(\"forwarded message\").attr(\"from\").split(\"/\", 1)[0] === selectedContact) {\n            recMessages = {\n              text: $(this).find(\"forwarded message body\").text(),\n              stamp: $(this).find(\"delay\").attr(\"stamp\"),\n              type: \"rec\"\n            };\n            history = history.concat(recMessages);\n          } else if ($(this).find(\"forwarded message\").attr(\"from\").split(\"/\", 1)[0] !== selectedContact) {\n            sentMessages = {\n              text: $(this).find(\"forwarded message body\").text(),\n              stamp: $(this).find(\"delay\").attr(\"stamp\"),\n              type: \"sent\"\n            };\n            history = history.concat(sentMessages);\n          }\n        });\n        return true;\n      },\n      onComplete: function (response) {\n        setHistoryMessages(history);\n        let chatDiv = document.querySelector(\".all-messages\");\n        chatDiv.scrollTo(0, chatDiv.scrollHeight);\n      }\n    });\n  };\n\n  const handleChangeMsg = event => {\n    changeMessageText(event.target.value);\n  };\n\n  const handleSubmit = e => {\n    e.preventDefault();\n    let txtJID = selectedContact,\n        txtMsg = messageText,\n        currentMessages = [],\n        message;\n    console.log(\"message1\", message);\n    console.log(\"txtJID\", txtJID);\n    console.log(\"txtMsg\", txtMsg);\n    if (txtMsg === undefined || txtMsg === \"\") alert(\"Empty Message, please type something\");else {\n      message = {\n        to: txtJID,\n        message: txtMsg,\n        time: new Date(),\n        type: \"sent\"\n      };\n      currentMessages = currentMessages.concat(message);\n      setAllMessages(allMessages.splice(0, 0, message));\n      sendMessage(message);\n      console.log(\"message\", messageText);\n      console.log(\"currentMessages\", currentMessages);\n      console.log(\"allmessages\", allMessages);\n    }\n    connection.addHandler(onMessage, null, \"message\", null, null, null);\n  }; //Sending message to contact\n\n\n  const sendMessage = msg => {\n    let reply = $msg({\n      to: msg.to,\n      from: connection.jid,\n      type: \"chat\",\n      id: \"event1\"\n    }).c(\"body\").t(msg.message).up().c(\"request\", {\n      xmlns: \"urn:xmpp:receipts\"\n    });\n    connection.send(reply.tree());\n  };\n\n  const onMessage = msg => {\n    let from = msg.getAttribute(\"from\");\n    let type = msg.getAttribute(\"type\");\n    let elems = msg.getElementsByTagName(\"body\");\n\n    if (type === \"error\") {\n      alert(\"An error occured! \");\n      return;\n    }\n\n    if (type === \"chat\") {\n      let message = {\n        from: from,\n        message: elems[0].innerHTML,\n        time: new Date(),\n        type: \"rec\"\n      };\n      console.log(\"rec message\", message);\n      setAllMessages(allMessages.splice(0, 0, message));\n    }\n\n    return true; //The handler should return true if it is to be invoked again; returning false will remove the handler after it returns\n  };\n  /*----------------RECENT ACTIVITY------------------*/\n\n\n  const onLastActivity = iq => {\n    let from = $(iq).attr(\"from\"); // the jabber_id of the contact\\+\n\n    let lastActivityObj;\n    let errorType = $(iq).attr('type');\n    console.log(\"errorType\", errorType);\n    $(iq).find(\"query\").each(function () {\n      if (errorType === \"result\") {\n        let lastActivityTime = $(iq).find(\"query\").attr('seconds');\n        lastActivityObj = {\n          from: from,\n          time: lastActivityTime\n        };\n        console.log(\"lastActivityObj\", lastActivityObj);\n        setLastActivity(_objectSpread({}, lastActivity, {\n          from: lastActivityObj.from,\n          time: lastActivityObj.time\n        }));\n      }\n\n      if (errorType === \"error\") {\n        let errorMessage = $(iq).find(\"text\").text();\n        console.log(\"errorMessage\", errorMessage);\n      }\n    });\n    return true;\n  };\n\n  const getLastActivity = () => {\n    const iq = $iq({\n      type: \"get\",\n      from: connection.jid,\n      to: selectedContact,\n      id: \"last1\"\n    }).c(\"query\", {\n      xmlns: \"jabber:iq:last\"\n    });\n    connection.sendIQ(iq);\n    connection.addHandler(onLastActivity, null, \"iq\", null, null, null);\n    console.log(\"iq\", iq);\n  };\n\n  useEffect(() => {\n    getLastActivity();\n  }, [selectedContact]);\n  return React.createElement(React.Fragment, {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 216\n    },\n    __self: this\n  }, React.createElement(\"p\", {\n    className: \"userId\",\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 217\n    },\n    __self: this\n  }, \"To : \", selectedContact), React.createElement(\"div\", {\n    className: \"search-bar\",\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 219\n    },\n    __self: this\n  }, React.createElement(Search, {\n    items: historyMessages,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 220\n    },\n    __self: this\n  })), React.createElement(\"div\", {\n    className: \"all-messages\",\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 222\n    },\n    __self: this\n  }, React.createElement(\"div\", {\n    className: \"messages\",\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 224\n    },\n    __self: this\n  }, allMessages !== [] ? React.createElement(MessagePopUp, {\n    type: allMessages.type,\n    sentMsg: allMessages.message,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 225\n    },\n    __self: this\n  }) : null)), React.createElement(\"div\", {\n    className: \"textbox\",\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 234\n    },\n    __self: this\n  }, React.createElement(\"input\", {\n    type: \"text\",\n    id: \"msg-here\",\n    className: \"form-control\",\n    placeholder: \"Message here...\",\n    rows: \"4\",\n    onChange: handleChangeMsg,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 235\n    },\n    __self: this\n  }), React.createElement(\"button\", {\n    type: \"button\",\n    value: \"send\",\n    className: \"primary\",\n    id: \"sendButton\",\n    onClick: handleSubmit,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 244\n    },\n    __self: this\n  }, \"send\")));\n};\n\nexport default ChatBox;","map":{"version":3,"sources":["/home/paria/sandbox/projects/webfon-V2/webfonv2/src/components/chat-box/index.js"],"names":["React","useEffect","useState","MessagePopUp","$","useSelector","Search","ChatBox","selectedContact","state","$iq","$msg","connection","showMainPage","historyMessages","setHistoryMessages","allMessages","setAllMessages","messageText","changeMessageText","sendLastActivity","getLog","sentMessages","recMessages","history","archiveIq","type","id","c","xmlns","t","mam","query","send","with","onMessage","message","each","find","attr","split","text","stamp","concat","onComplete","response","chatDiv","document","querySelector","scrollTo","scrollHeight","handleChangeMsg","event","target","value","handleSubmit","e","preventDefault","txtJID","txtMsg","currentMessages","console","log","undefined","alert","to","time","Date","splice","sendMessage","addHandler","msg","reply","from","jid","up","tree","getAttribute","elems","getElementsByTagName","innerHTML","onLastActivity","iq","lastActivityObj","errorType","lastActivityTime","setLastActivity","lastActivity","errorMessage","getLastActivity","sendIQ"],"mappings":"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","sourcesContent":["import React, {useEffect, useState} from \"react\";\nimport MessagePopUp from \"../message-popup\";\nimport \"./style.css\";\nimport $ from \"jquery\";\nimport {useSelector} from \"react-redux\";\nimport Search from \"../search/search\";\n\nconst ChatBox = () => {\n    const selectedContact = useSelector(state => state.selectedContact);\n    const $iq = useSelector(state => state.$iq);\n    const $msg = useSelector(state => state.$msg);\n    const connection = useSelector(state => state.connection);\n    const showMainPage = useSelector(state => state.showMainPage);\n    const [historyMessages, setHistoryMessages] = useState([]);\n    const [allMessages, setAllMessages] = useState([]);\n    const [messageText, changeMessageText] = useState(\"\");\n    const sendLastActivity = useSelector(state => state.sendLastActivity);\n\n    useEffect(() => {\n        getLog();\n    }, [selectedContact]);\n\n    const getLog = () => {\n\n        let sentMessages,\n            recMessages,\n            history = [],\n            archiveIq = $iq({\n                type: \"set\",\n                id: \"archive1\"\n\n            }).c(\"query\", {\n                xmlns: \"urn:xmpp:mam:2\"\n            }).c(\"set\", {xmlns: \"http://jabber.org/protocol/rsm\"}).c('max').t('5');\n        connection.mam.query(connection.send(archiveIq), {\n            with: selectedContact,\n            onMessage: function (message) {\n                $(message).each(function () {\n                    if (\n                        $(this)\n                            .find(\"forwarded message\")\n                            .attr(\"from\")\n                            .split(\"/\", 1)[0] === selectedContact\n                    ) {\n                        recMessages = {\n                            text: $(this)\n                                .find(\"forwarded message body\")\n                                .text(),\n                            stamp: $(this)\n                                .find(\"delay\")\n                                .attr(\"stamp\"),\n                            type: \"rec\"\n                        };\n                        history = history.concat(recMessages);\n                    } else if (\n                        $(this)\n                            .find(\"forwarded message\")\n                            .attr(\"from\")\n                            .split(\"/\", 1)[0] !== selectedContact\n                    ) {\n                        sentMessages = {\n                            text: $(this)\n                                .find(\"forwarded message body\")\n                                .text(),\n                            stamp: $(this)\n                                .find(\"delay\")\n                                .attr(\"stamp\"),\n                            type: \"sent\"\n                        };\n\n                        history = history.concat(sentMessages);\n                    }\n                });\n\n                return true;\n            },\n            onComplete: function (response) {\n                setHistoryMessages(history);\n                let chatDiv = document.querySelector(\".all-messages\");\n                chatDiv.scrollTo(0, chatDiv.scrollHeight);\n            }\n        });\n    }\n\n\n    const handleChangeMsg = (event) => {\n        changeMessageText(event.target.value)\n    };\n\n\n    const handleSubmit = (e) => {\n        e.preventDefault();\n        let txtJID = selectedContact,\n            txtMsg = messageText,\n            currentMessages = [],\n            message;\n        console.log(\"message1\", message)\n\n        console.log(\"txtJID\", txtJID);\n        console.log(\"txtMsg\", txtMsg);\n\n        if (txtMsg === undefined || txtMsg === \"\")\n            alert(\"Empty Message, please type something\");\n        else {\n            message = {\n                to: txtJID,\n                message: txtMsg,\n                time: new Date(),\n                type: \"sent\"\n            };\n            currentMessages = currentMessages.concat(message)\n\n            setAllMessages(allMessages.splice(0, 0, message));\n            sendMessage(message);\n            console.log(\"message\", messageText)\n            console.log(\"currentMessages\", currentMessages)\n            console.log(\"allmessages\", allMessages)\n        }\n        connection.addHandler(\n            onMessage,\n            null,\n            \"message\",\n            null,\n            null,\n            null\n        );\n    };\n\n    //Sending message to contact\n    const sendMessage = (msg) => {\n        let reply = $msg({\n            to: msg.to,\n            from: connection.jid,\n            type: \"chat\",\n            id: \"event1\"\n        })\n            .c(\"body\")\n            .t(msg.message)\n            .up()\n            .c(\"request\", {xmlns: \"urn:xmpp:receipts\"});\n\n        connection.send(reply.tree());\n    }\n\n    const onMessage = (msg) => {\n        let from = msg.getAttribute(\"from\");\n        let type = msg.getAttribute(\"type\");\n        let elems = msg.getElementsByTagName(\"body\");\n        if (type === \"error\") {\n            alert(\"An error occured! \");\n            return;\n        }\n\n        if (type === \"chat\") {\n            let message = {\n                from: from,\n                message: elems[0].innerHTML,\n                time: new Date(),\n                type: \"rec\"\n            };\n            console.log(\"rec message\", message)\n            setAllMessages(allMessages.splice(0, 0, message));\n\n        }\n\n        return true; //The handler should return true if it is to be invoked again; returning false will remove the handler after it returns\n    }\n\n\n    /*----------------RECENT ACTIVITY------------------*/\n    const onLastActivity = (iq) => {\n\n        let from = $(iq).attr(\"from\"); // the jabber_id of the contact\\+\n        let lastActivityObj;\n        let errorType = $(iq).attr('type');\n        console.log(\"errorType\", errorType);\n\n        $(iq).find(\"query\").each(function () {\n\n            if (errorType === \"result\") {\n                let lastActivityTime = $(iq).find(\"query\").attr('seconds');\n                lastActivityObj = {\n                    from: from,\n                    time: lastActivityTime\n                };\n                console.log(\"lastActivityObj\", lastActivityObj);\n                setLastActivity({...lastActivity, from: lastActivityObj.from, time: lastActivityObj.time});\n            }\n            if (errorType === \"error\") {\n                let errorMessage = $(iq).find(\"text\").text();\n                console.log(\"errorMessage\", errorMessage)\n            }\n\n        });\n        return true\n\n    };\n    const getLastActivity = () => {\n        const iq = $iq({\n            type: \"get\",\n            from: connection.jid,\n            to: selectedContact,\n            id: \"last1\"\n        }).c(\"query\", {xmlns: \"jabber:iq:last\"});\n        connection.sendIQ(iq);\n        connection.addHandler(onLastActivity, null, \"iq\", null, null, null);\n\n        console.log(\"iq\", iq)\n    };\n    useEffect(() => {\n        getLastActivity();\n    }, [selectedContact]);\n\n\n    return (\n        <React.Fragment>\n            <p className=\"userId\">To : {selectedContact}</p>\n\n            <div className=\"search-bar\">\n                <Search items={historyMessages}/>\n            </div>\n            <div className=\"all-messages\">\n\n                <div className=\"messages\">\n                    {allMessages !== [] ? <MessagePopUp\n                        type={allMessages.type}\n                        sentMsg={allMessages.message}\n                    /> : null}\n\n\n                </div>\n            </div>\n\n            <div className=\"textbox\">\n                <input\n                    type=\"text\"\n                    id=\"msg-here\"\n                    className=\"form-control\"\n                    placeholder=\"Message here...\"\n                    rows=\"4\"\n                    onChange={handleChangeMsg}\n                />\n\n                <button\n                    type=\"button\"\n                    value=\"send\"\n                    className=\"primary\"\n                    id=\"sendButton\"\n                    onClick={handleSubmit}\n                >send\n                </button>\n            </div>\n        </React.Fragment>\n    );\n}\n\n\nexport default ChatBox;\n"]},"metadata":{},"sourceType":"module"}