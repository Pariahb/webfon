{"ast":null,"code":"import _defineProperty from \"/home/paria/sandbox/projects/webfon-V2/webfonv2/node_modules/@babel/runtime/helpers/esm/defineProperty\";\nimport _slicedToArray from \"/home/paria/sandbox/projects/webfon-V2/webfonv2/node_modules/@babel/runtime/helpers/esm/slicedToArray\";\nvar _jsxFileName = \"/home/paria/sandbox/projects/webfon-V2/webfonv2/src/components/chat/chat-box/index.js\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nimport React, { useEffect, useState } from \"react\";\nimport MessagePopUp from \"../message-popup\";\nimport \"./style.css\";\nimport $ from \"jquery\";\nimport { useSelector } from \"react-redux\";\n\nconst ChatBox = () => {\n  const selectedContact = useSelector(state => state.selectedContact);\n  const rosterStatus = useSelector(state => state.rosterStatus);\n  const $iq = useSelector(state => state.$iq);\n  const $msg = useSelector(state => state.$msg);\n  const connection = useSelector(state => state.connection); // const showMainPage = useSelector(state => state.showMainPage);\n\n  const _useState = useState({\n    item: []\n  }),\n        _useState2 = _slicedToArray(_useState, 2),\n        historyMessages = _useState2[0],\n        setHistoryMessages = _useState2[1];\n\n  const _useState3 = useState({\n    item: []\n  }),\n        _useState4 = _slicedToArray(_useState3, 2),\n        allMessages = _useState4[0],\n        setAllMessages = _useState4[1];\n\n  const _useState5 = useState({}),\n        _useState6 = _slicedToArray(_useState5, 2),\n        recMessages = _useState6[0],\n        setRecMessages = _useState6[1];\n\n  const _useState7 = useState(\"\"),\n        _useState8 = _slicedToArray(_useState7, 2),\n        messageText = _useState8[0],\n        changeMessageText = _useState8[1];\n\n  const _useState9 = useState({\n    from: '',\n    time: ''\n  }),\n        _useState10 = _slicedToArray(_useState9, 2),\n        lastActivity = _useState10[0],\n        setLastActivity = _useState10[1];\n\n  const scrollToBottom = () => {\n    let chatDiv = document.querySelector(\".all-messages\");\n    chatDiv.scrollTo(0, chatDiv.scrollHeight);\n    console.log(\"hi\");\n  };\n\n  useEffect(() => {\n    getLog();\n  }, [selectedContact]);\n\n  const getLog = () => {\n    let mySentMessages,\n        myRecMessages,\n        sents = [],\n        recs = [],\n        history = [],\n        archiveIq = $iq({\n      type: \"set\",\n      id: \"archive1\"\n    }).c(\"query\", {\n      xmlns: \"urn:xmpp:mam:2\"\n    }).c(\"set\", {\n      xmlns: \"http://jabber.org/protocol/rsm\"\n    });\n    connection.mam.query(connection.send(archiveIq), {\n      with: selectedContact,\n      onMessage: function (message) {\n        $(message).each(function () {\n          console.log(\"$(message)\", $(message).find(\"forwarded message\").attr(\"from\").split(\"/\", 1)[0]);\n          console.log(\"selectedContact\", selectedContact);\n          console.log(\"connection.jid\", connection.jid);\n\n          if ($(this).find(\"forwarded message\").attr(\"from\").split(\"/\", 1)[0] === selectedContact) {\n            myRecMessages = {\n              text: $(this).find(\"forwarded message body\").text(),\n              stamp: $(this).find(\"delay\").attr(\"stamp\"),\n              type: \"rec\"\n            };\n            console.log(\"myRecMessages\", myRecMessages);\n            history = history.concat(myRecMessages);\n          } else if ($(this).find(\"forwarded message\").attr(\"from\").split(\"/\", 1)[0] === connection.jid.split(\"/\", 1)[0]) {\n            mySentMessages = {\n              text: $(this).find(\"forwarded message body\").text(),\n              stamp: $(this).find(\"delay\").attr(\"stamp\"),\n              type: \"sent\"\n            };\n            console.log(\"mySentMessages\", mySentMessages);\n            history = history.concat(mySentMessages);\n          }\n        });\n        return true;\n      },\n      onComplete: function (response) {\n        setHistoryMessages(history);\n        scrollToBottom();\n      }\n    });\n  };\n\n  const handleChangeMsg = event => {\n    changeMessageText(event.target.value);\n  };\n\n  const handleSubmit = () => {\n    console.log(\"selectedContact\", selectedContact);\n    let txtJID = selectedContact,\n        txtMsg = messageText,\n        message;\n    if (txtMsg === undefined || txtMsg === \"\") alert(\"Empty Message, please type something\");else {\n      message = {\n        to: txtJID,\n        message: txtMsg,\n        time: new Date(),\n        type: \"sent\"\n      };\n      console.log(\"txtMsg\", txtMsg);\n      sendMessage(message);\n      console.log(\"type\", typeof allMessages);\n    }\n    connection.addHandler(onMessage, null, \"message\", null, null, null);\n    scrollToBottom();\n  }; //Sending message to contact\n\n\n  const sendMessage = msg => {\n    let reply = $msg({\n      to: msg.to,\n      from: connection.jid,\n      type: \"chat\",\n      id: \"message-1\"\n    }).c(\"body\").t(msg.message).up().c(\"thread\").t(\"salam\");\n    connection.send(reply.tree());\n    let sentArray = allMessages.item;\n    sentArray.push(msg);\n    setAllMessages(_objectSpread({}, allMessages, {\n      item: sentArray\n    }));\n    console.log(\"allmessages\", allMessages);\n  };\n\n  const listMessages = () => {\n    return allMessages.item.length === 0 ? '' : allMessages.item.map((item, i) => {\n      return React.createElement(MessagePopUp, {\n        key: i,\n        sentMsg: item.message,\n        type: item.type,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 160\n        },\n        __self: this\n      });\n    });\n  };\n\n  const onMessage = msg => {\n    let from = msg.getAttribute(\"from\");\n    let type = msg.getAttribute(\"type\");\n    let elems = msg.getElementsByTagName(\"body\");\n\n    if (type === \"error\") {\n      alert(\"An error occured! \");\n      return;\n    }\n\n    if (type === \"chat\") {\n      let message = {\n        from: from,\n        message: elems[0].innerHTML,\n        time: new Date(),\n        type: \"rec\"\n      };\n      let recArray = allMessages.item;\n      console.log(\"recArray1\", recArray);\n      recArray.push(message);\n      console.log(\"recArray2\", recArray);\n      setAllMessages(_objectSpread({}, allMessages, {\n        item: recArray\n      }));\n      console.log(\"setAllMessages\", allMessages);\n    }\n\n    return true; //The handler should return true if it is to be invoked again; returning false will remove the handler after it returns\n  };\n  /*----------------RECENT ACTIVITY------------------*/\n\n\n  const onLastActivity = iq => {\n    let from = $(iq).attr(\"from\"); // the jabber_id of the contact\\+\n\n    let lastActivityObj;\n    let errorType = $(iq).attr('type');\n    $(iq).find(\"query\").each(function () {\n      if (errorType === \"result\") {\n        let lastActivityTime = $(iq).find(\"query\").attr('seconds');\n        lastActivityObj = {\n          from: from,\n          time: lastActivityTime,\n          type: errorType,\n          errorMessage: null\n        };\n        setLastActivity(_objectSpread({}, lastActivity, {\n          from: lastActivityObj.from,\n          time: lastActivityObj.time,\n          type: lastActivityObj.type,\n          errorMessage: lastActivityObj.errorMessage\n        }));\n      }\n\n      if (errorType === \"error\") {\n        let errorMessage = $(iq).find(\"text\").text();\n        lastActivityObj = {\n          from: from,\n          time: null,\n          type: errorType,\n          errorMessage: errorMessage\n        };\n        setLastActivity(_objectSpread({}, lastActivity, {\n          from: lastActivityObj.from,\n          time: lastActivityObj.time,\n          type: lastActivityObj.type,\n          errorMessage: lastActivityObj.errorMessage\n        }));\n      }\n    });\n    return true;\n  };\n\n  const getLastActivity = () => {\n    const iq = $iq({\n      type: \"get\",\n      from: connection.jid,\n      to: selectedContact,\n      id: \"last1\"\n    }).c(\"query\", {\n      xmlns: \"jabber:iq:last\"\n    });\n    connection.sendIQ(iq);\n    connection.addHandler(onLastActivity, null, \"iq\", null, null, null);\n  };\n\n  useEffect(() => {\n    getLastActivity();\n  }, [selectedContact]);\n  useEffect(() => {\n    getLastActivity();\n  }, [rosterStatus]);\n  return React.createElement(React.Fragment, {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 268\n    },\n    __self: this\n  }, React.createElement(\"div\", {\n    className: \"userInfo-bar\",\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 269\n    },\n    __self: this\n  }, React.createElement(\"p\", {\n    className: \"userId\",\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 270\n    },\n    __self: this\n  }, selectedContact), React.createElement(\"p\", {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 271\n    },\n    __self: this\n  }, lastActivity.type === \"error\" ? \"Last seen recently\" : lastActivity.time === \"0\" ? \"online\" : lastActivity.time < 60 ? \"last seen \" + lastActivity.time + \" seconds ago\" : Math.floor(lastActivity.time / 60) < 60 ? \"last seen \" + Math.floor(lastActivity.time / 60) + \" minutes ago\" : Math.floor(lastActivity.time / 3600) < 24 ? \"last seen \" + Math.floor(lastActivity.time / 3600) + \" hours ago\" : Math.floor(lastActivity.time / 86400) < 7 ? \"last seen \" + Math.floor(lastActivity.time / 86400) + \" days ago\" : \"last seen over a week ago\")), React.createElement(\"div\", {\n    className: \"all-messages\",\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 283\n    },\n    __self: this\n  }, React.createElement(\"div\", {\n    className: \"archive\",\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 284\n    },\n    __self: this\n  }), React.createElement(\"div\", {\n    className: \"messages\",\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 295\n    },\n    __self: this\n  }, listMessages())), React.createElement(\"div\", {\n    className: \"textbox\",\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 300\n    },\n    __self: this\n  }, React.createElement(\"input\", {\n    type: \"text\",\n    id: \"msg-here\",\n    className: \"form-control\",\n    placeholder: \"Message here...\",\n    rows: \"4\",\n    value: messageText,\n    onChange: handleChangeMsg,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 301\n    },\n    __self: this\n  }), React.createElement(\"button\", {\n    type: \"button\",\n    value: \"send\",\n    className: \"primary\",\n    id: \"sendButton\",\n    onClick: handleSubmit,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 311\n    },\n    __self: this\n  }, \"send\")));\n};\n\nexport default ChatBox;","map":{"version":3,"sources":["/home/paria/sandbox/projects/webfon-V2/webfonv2/src/components/chat/chat-box/index.js"],"names":["React","useEffect","useState","MessagePopUp","$","useSelector","ChatBox","selectedContact","state","rosterStatus","$iq","$msg","connection","item","historyMessages","setHistoryMessages","allMessages","setAllMessages","recMessages","setRecMessages","messageText","changeMessageText","from","time","lastActivity","setLastActivity","scrollToBottom","chatDiv","document","querySelector","scrollTo","scrollHeight","console","log","getLog","mySentMessages","myRecMessages","sents","recs","history","archiveIq","type","id","c","xmlns","mam","query","send","with","onMessage","message","each","find","attr","split","jid","text","stamp","concat","onComplete","response","handleChangeMsg","event","target","value","handleSubmit","txtJID","txtMsg","undefined","alert","to","Date","sendMessage","addHandler","msg","reply","t","up","tree","sentArray","push","listMessages","length","map","i","getAttribute","elems","getElementsByTagName","innerHTML","recArray","onLastActivity","iq","lastActivityObj","errorType","lastActivityTime","errorMessage","getLastActivity","sendIQ","Math","floor"],"mappings":"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","sourcesContent":["import React, {useEffect, useState} from \"react\";\nimport MessagePopUp from \"../message-popup\";\nimport \"./style.css\";\nimport $ from \"jquery\";\nimport {useSelector} from \"react-redux\";\n\nconst ChatBox = () => {\n    const selectedContact = useSelector(state => state.selectedContact);\n    const rosterStatus = useSelector(state => state.rosterStatus);\n    const $iq = useSelector(state => state.$iq);\n    const $msg = useSelector(state => state.$msg);\n    const connection = useSelector(state => state.connection);\n    // const showMainPage = useSelector(state => state.showMainPage);\n    const [historyMessages, setHistoryMessages] = useState({item: []});\n    const [allMessages, setAllMessages] = useState({item: []});\n    const [recMessages, setRecMessages] = useState({});\n    const [messageText, changeMessageText] = useState(\"\");\n    const [lastActivity, setLastActivity] = useState({from: '', time: ''});\n\n    const scrollToBottom = () => {\n        let chatDiv = document.querySelector(\".all-messages\");\n        chatDiv.scrollTo(0, chatDiv.scrollHeight);\n        console.log(\"hi\")\n    };\n    useEffect(() => {\n        getLog();\n    }, [selectedContact]);\n\n    const getLog = () => {\n\n        let mySentMessages,\n            myRecMessages,\n            sents = [],\n            recs = [],\n            history = [],\n            archiveIq = $iq({\n                type: \"set\",\n                id: \"archive1\"\n\n            }).c(\"query\", {\n                xmlns: \"urn:xmpp:mam:2\"\n            }).c(\"set\", {xmlns: \"http://jabber.org/protocol/rsm\"});\n\n        connection.mam.query(connection.send(archiveIq), {\n            with: selectedContact,\n            onMessage: function (message) {\n                $(message).each(function () {\n                    console.log(\"$(message)\", $(message).find(\"forwarded message\")\n                        .attr(\"from\").split(\"/\", 1)[0]);\n                    console.log(\"selectedContact\",selectedContact);\n                    console.log(\"connection.jid\",connection.jid);\n                    if (\n                        $(this)\n                            .find(\"forwarded message\")\n                            .attr(\"from\")\n                            .split(\"/\", 1)[0] === selectedContact\n                    ) {\n                        myRecMessages = {\n                            text: $(this)\n                                .find(\"forwarded message body\")\n                                .text(),\n                            stamp: $(this)\n                                .find(\"delay\")\n                                .attr(\"stamp\"),\n                            type: \"rec\"\n                        };\n                        console.log(\"myRecMessages\", myRecMessages)\n                        history = history.concat(myRecMessages);\n                    } else if (\n                        $(this)\n                            .find(\"forwarded message\")\n                            .attr(\"from\")\n                            .split(\"/\", 1)[0] === connection.jid.split(\"/\", 1)[0]\n                    ) {\n                        mySentMessages = {\n                            text: $(this)\n                                .find(\"forwarded message body\")\n                                .text(),\n                            stamp: $(this)\n                                .find(\"delay\")\n                                .attr(\"stamp\"),\n                            type: \"sent\"\n                        };\n                        console.log(\"mySentMessages\", mySentMessages)\n\n                        history = history.concat(mySentMessages);\n                    }\n                });\n                return true;\n            },\n            onComplete: function (response) {\n                setHistoryMessages(history)\n                scrollToBottom();\n            }\n        });\n    };\n\n    const handleChangeMsg = (event) => {\n        changeMessageText(event.target.value)\n    };\n\n    const handleSubmit = () => {\n        console.log(\"selectedContact\", selectedContact);\n        let txtJID = selectedContact,\n            txtMsg = messageText,\n            message;\n\n        if (txtMsg === undefined || txtMsg === \"\")\n            alert(\"Empty Message, please type something\");\n        else {\n            message = {\n                to: txtJID,\n                message: txtMsg,\n                time: new Date(),\n                type: \"sent\"\n            };\n            console.log(\"txtMsg\", txtMsg);\n            sendMessage(message);\n            console.log(\"type\", typeof (allMessages))\n\n        }\n        connection.addHandler(\n            onMessage,\n            null,\n            \"message\",\n            null,\n            null,\n            null\n        );\n        scrollToBottom();\n    };\n\n    //Sending message to contact\n    const sendMessage = (msg) => {\n        let reply = $msg({\n            to: msg.to,\n            from: connection.jid,\n            type: \"chat\",\n            id: \"message-1\"\n        })\n            .c(\"body\")\n            .t(msg.message).up().c(\"thread\").t(\"salam\");\n        connection.send(reply.tree());\n\n        let sentArray = allMessages.item;\n        sentArray.push(msg);\n        setAllMessages({\n            ...allMessages,\n            item: sentArray\n        });\n        console.log(\"allmessages\", allMessages)\n\n    };\n\n    const listMessages = () => {\n\n        return (\n            allMessages.item.length === 0 ? '' : allMessages.item.map((item, i) => {\n                return (\n                    <MessagePopUp\n                        key={i}\n                        sentMsg={item.message}\n                        type={item.type}\n                    />\n                );\n            }))\n\n    };\n    const onMessage = (msg) => {\n        let from = msg.getAttribute(\"from\");\n        let type = msg.getAttribute(\"type\");\n        let elems = msg.getElementsByTagName(\"body\");\n        if (type === \"error\") {\n            alert(\"An error occured! \");\n            return;\n        }\n\n\n        if (type === \"chat\") {\n            let message = {\n                from: from,\n                message: elems[0].innerHTML,\n                time: new Date(),\n                type: \"rec\"\n            };\n\n            let recArray = allMessages.item;\n            console.log(\"recArray1\", recArray)\n\n            recArray.push(message);\n            console.log(\"recArray2\", recArray)\n\n            setAllMessages({\n                ...allMessages,\n                item: recArray\n            });\n            console.log(\"setAllMessages\", allMessages)\n\n\n        }\n        return true; //The handler should return true if it is to be invoked again; returning false will remove the handler after it returns\n    };\n\n    /*----------------RECENT ACTIVITY------------------*/\n    const onLastActivity = (iq) => {\n\n        let from = $(iq).attr(\"from\"); // the jabber_id of the contact\\+\n        let lastActivityObj;\n        let errorType = $(iq).attr('type');\n        $(iq).find(\"query\").each(function () {\n\n            if (errorType === \"result\") {\n                let lastActivityTime = $(iq).find(\"query\").attr('seconds');\n                lastActivityObj = {\n                    from: from,\n                    time: lastActivityTime,\n                    type: errorType,\n                    errorMessage: null\n                };\n                setLastActivity({\n                    ...lastActivity, from: lastActivityObj.from,\n                    time: lastActivityObj.time,\n                    type: lastActivityObj.type,\n                    errorMessage: lastActivityObj.errorMessage\n                });\n            }\n            if (errorType === \"error\") {\n                let errorMessage = $(iq).find(\"text\").text();\n                lastActivityObj = {\n                    from: from,\n                    time: null,\n                    type: errorType,\n                    errorMessage: errorMessage\n                };\n                setLastActivity({\n                    ...lastActivity,\n                    from: lastActivityObj.from,\n                    time: lastActivityObj.time,\n                    type: lastActivityObj.type,\n                    errorMessage: lastActivityObj.errorMessage\n                });\n\n            }\n\n        });\n        return true\n\n    };\n    const getLastActivity = () => {\n        const iq = $iq({\n            type: \"get\",\n            from: connection.jid,\n            to: selectedContact,\n            id: \"last1\"\n        }).c(\"query\", {xmlns: \"jabber:iq:last\"});\n        connection.sendIQ(iq);\n        connection.addHandler(onLastActivity, null, \"iq\", null, null, null);\n    };\n    useEffect(() => {\n        getLastActivity();\n    }, [selectedContact]);\n\n    useEffect(() => {\n        getLastActivity();\n    }, [rosterStatus]);\n\n    return (\n        <React.Fragment>\n            <div className=\"userInfo-bar\">\n                <p className=\"userId\">{selectedContact}</p>\n                <p>{lastActivity.type === \"error\" ? \"Last seen recently\" : lastActivity.time === \"0\" ? \"online\"\n                    : lastActivity.time < 60 ? \"last seen \" + lastActivity.time + \" seconds ago\"\n                        : Math.floor(lastActivity.time / 60) < 60 ? \"last seen \" + Math.floor(lastActivity.time / 60) + \" minutes ago\"\n                            : Math.floor(lastActivity.time / 3600) < 24 ? \"last seen \" + Math.floor(lastActivity.time / 3600) + \" hours ago\"\n                                : Math.floor(lastActivity.time / 86400) < 7 ? \"last seen \" + Math.floor(lastActivity.time / 86400) + \" days ago\" : \"last seen over a week ago\"\n                }</p>\n            </div>\n\n            {/*<div className=\"search-bar\">*/}\n            {/*    <Search items={historyMessages}/>*/}\n            {/*</div>*/}\n\n            <div className=\"all-messages\">\n                <div className=\"archive\">\n                    {/*{historyMessages.item[0].map((item, i) => {*/}\n                    {/*    return (*/}\n                    {/*        <MessagePopUp*/}\n                    {/*            key={i}*/}\n                    {/*            sentMsg={item.text}*/}\n                    {/*            type={item.type}*/}\n                    {/*        />*/}\n                    {/*    );*/}\n                    {/*})}*/}\n                </div>\n                <div className=\"messages\">\n                    {listMessages()}\n                </div>\n            </div>\n\n            <div className=\"textbox\">\n                <input\n                    type=\"text\"\n                    id=\"msg-here\"\n                    className=\"form-control\"\n                    placeholder=\"Message here...\"\n                    rows=\"4\"\n                    value={messageText}\n                    onChange={handleChangeMsg}\n                />\n\n                <button\n                    type=\"button\"\n                    value=\"send\"\n                    className=\"primary\"\n                    id=\"sendButton\"\n                    onClick={handleSubmit}\n                >send\n                </button>\n            </div>\n        </React.Fragment>\n    );\n}\n\n\nexport default ChatBox;\n"]},"metadata":{},"sourceType":"module"}